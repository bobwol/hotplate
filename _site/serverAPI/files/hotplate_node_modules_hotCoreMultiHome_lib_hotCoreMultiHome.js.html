<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Hotplate server API</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="stylesheet" href="../assets/css/weblookalike.css" id="site_styles">
    <link rel="stylesheet" href="/global/header.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">


    <!-- HEADER -->
    <div id="header_wrap" class="outer">

        <div class="main_menu">
             <span><a href="/">Home</a></span>
             <span><a href="/guide.html">Guide</a></span>
             <span><a href="/serverAPI/index.html">Server API</a></span>
             <span><a href="/clientAPI/index.html">Client API</a></span>
        </div>

        <header class="inner">
          <a id="forkme_banner" href="https://github.com/mercmobily/hotplate">View on GitHub</a>

            
          <h1 id="project_title">Hotplate server API</h1>
          <h2 id="project_tagline">Multi-homed SaaS with NodeJs, Express, (any)DB, Dojo</h2>

            <section id="downloads">
              <a class="zip_download_link" href="https://github.com/mercmobily/hotplate/zipball/master">Download this project as a .zip file</a>
              <a class="tar_download_link" href="https://github.com/mercmobily/hotplate/tarball/master">Download this project as a tar.gz file</a>
            </section>
        </header>
    </div>



<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">




           <!-- 
            
                <h1><img src="../assets/css/logo.png" title=""></h1>
            
            -->

        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: </em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
                <li><a href="../classes/hotCoreAuth.html">hotCoreAuth</a></li>
            
                <li><a href="../classes/hotCoreAuth.facebook.html">hotCoreAuth.facebook</a></li>
            
                <li><a href="../classes/hotCoreClientFiles.html">hotCoreClientFiles</a></li>
            
                <li><a href="../classes/hotCoreMultiHome.html">hotCoreMultiHome</a></li>
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
                <li><a href="../modules/hotCoreAuth.html">hotCoreAuth</a></li>
            
                <li><a href="../modules/hotCoreClientFiles.html">hotCoreClientFiles</a></li>
            
                <li><a href="../modules/hotCoreMultiHome.html">hotCoreMultiHome</a></li>
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: hotplate/node_modules/hotCoreMultiHome/lib/hotCoreMultiHome.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/**
Provides multi-home abilities to Hotplate

This module&#x27;s aim is to make sure Hotplate has full multi-home abilities. The module itself:

* Defines all of the relevant stores ( &#x60;workspaces&#x60;, &#x60;workspaceUsers&#x60;, &#x60;userWorkspaces&#x60;)
* Places important variables on the rendered page ( &#x60;vars.hotCoreMultiHome.enabled&#x60; and &#x60;.multiHomeURL&#x60;)
* Places the crucial &#x60;vars.hotCoreMultiHome.workspaceId&#x60; variable on the rendered page

However, given the nature of this module, there are _several_ other modules in Hotplate that interact with it.

## SUMMARY: modules that deal with multihome environments:

* hotCoreJsonRestStores -- it will broadcast comet messages only to workspace users
* hotCoreStoreConfig -- if the url has &#x60;:workspaceId&#x60;, it will set config stores&#x27; records in the page for that workspace
* hotDojoGlobals -- will set global variable workspaceId if it&#x27;s set within the page
* hotDojoStoreConfig -- will call &#x60;stores()&#x60; passing &#x60;userId&#x60; and &#x60;workspaceId&#x60; in resolution hash, allowing easy workspace-bound setting lists
* hotDojoAppContainer -- fully multi-home aware, will hook to correct URL and, if &#x60;:workspaceId&#x60; is in the URL, it will check that it exists.
* hotDojoAuth -- fully multi-home aware, providing a pick mechanism etc. Gets the workspace URL from &#x60;vars.hotCoreMultiHome.multiHomeURL&#x60; 

* hotDojoComet -- will add header &#x60;X-hotplate-workspaceId&#x60; to tab messages requests
* hotCoreComet -- will use &#x60;X-hotplate-workspaceId&#x60; to return updated config records for the expired workspace

A more detailed explanation of what each module does, in terms of interaction with hotCoreMultiHome, follows. Note that any interaction happens on the basis that &#x60;hotCoreMultiHome&#x60; is enabled.

## hotCoreJsonRestStores

* ./node_modules/hotCoreJsonRestStores/lib/hotCoreJsonRestStores.js

When broadcasting changes to stores via the hook &#x60;cometBroadcast&#x60;, it will change its behavious depending on multi-home being enabled or not.

If multiHome is enabled, checks if the record has a workspaceId field -- in which case, it will only broadcast the message to users in that workspaceId (it will do so by passing a &#x60;makeTabIdHash()&#x60; function to the &#x60;cometBroadcast&#x60; hook) 

## hotCoreStoreConfig

* ./node_modules/hotCoreStoreConfig/lib/hotCoreStoreConfig.js

Implements &#x60;pageElementsPerPage&#x60; that passes &#x60;params.workspaceId&#x60; to &#x60;getConfig()&#x60; -- which means that if the URL has the &#x60;workspaceId&#x60; parameter, it will add a variable with the workspace&#x27;s configuration to the page. It also passes &#x60;session.userId&#x60; to &#x60;getConfig()&#x60;, so if the user is logged in, it will return that user&#x27;s config too.

NOTE: &#x60;getConfig()&#x60; is implemented here. Signature: &#x60;function( workspaceId, userId, cb )&#x60;. It basically will return all configs with &#x60;workspaceId&#x60; and/or &#x60;userId&#x60; set in their &#x60;store.configStore&#x60; property

## hotDojoGlobals

* ./node_modules/hotDojoGlobals/client/globals.js

Sets the global variable &#x60;workspaceId&#x60; based on &#x60;vars.hotCoreMultiHome.workspaceId&#x60; (Unrelated: it also sets &#x60;userId&#x60; based in &#x60;vars.hotCoreAuth.userId&#x60;)

## hotDojoStoreConfig

* ./node_modules/hotDojoStoreConfig/client/ConfigVars.js

Config variables are bound to &quot;nothing&quot; (system-wide settings), to a user (user-wide settings), to a workspace (workspace-wide settings) or both (user-specific settings for a specific workspace). That&#x27;s why ConfigVars will call &#x60;stores()&#x60; passing &#x60;:userId&#x60; and :&#x60;workspaceId&#x60; in resolution hash.

Note that &#x60;:workspaceId&#x60; and &#x60;userId&#x60; are the ONLY parameters allowed in a config store URL.


## hotDojoAppContainer

* ./node_modules/hotDojoAppContainer/lib/hotDojoAppContainer.js

In terms of URLs, it will attach to &#x60;hotCoreMultiHome.multiHomeURL&#x60; or &#x60;hotCoreAuth.appURL&#x60; depending on multi-home being enabled or not. Also, IF &#x60;:workspaceId&#x60; is in the URL as a parameter, it will check that the workspace actually exists or it will return an error.

## hotDojoAuth

* ./node_modules/hotDojoAuth/lib/hotDojoAuth.js

The pagePick callback is there just for multi-home environments, picking the workspace

* ./node_modules/hotDojoAuth/client/NewWorkspace.js

After adding a new workspace, it will redirect to it thanks to &#x60;vars.hotCoreMultiHome.multiHomeURL&#x60; (replacing &#x60;:workspaceId&#x60; with the id of the record that was just created) 

* ./node_modules/hotDojoAuth/client/Pick.js

After picking a workspace, it will redirect to it thanks to &#x60;vars.hotCoreMultiHome.multiHomeURL&#x60; as above

* ./node_modules/hotDojoStoreConfig/client/ConfigVars.js

## hotDojoComet

* ./node_modules/hotDojoComet/client/messages.js

It adds a header &#x60;X-hotplate-workspaceId&#x60; to tabId requests. This is ESSENTIAL so that hotCoreComet knows which workspaceId the tab belongs to. Yes, IT NEEDS to know it: if the tab is not found or it&#x27;s expired, hotCoreComet will return only one message, &#x60;resetStores&#x60;, which will INCLUDE all configuration records for that user and workspace (in order to save GETs and implement error management app-side).

## hotCoreComet

* ./node_modules/hotCoreComet/lib/hotCoreComet.js

Uses the header &#x60;X-hotplate-workspaceId&#x60; to return the config stores&#x27; records for that &#x60;workspaceId&#x60; in case the tab is expired or not there

@module hotCoreMultiHome
@main hotCoreMultiHome
@class hotCoreMultiHome
@static
*/


var dummy
  , hotplate = require(&#x27;hotplate&#x27;)

  , e = require(&#x27;allhttperrors&#x27;)

  , SimpleSchema = require(&#x27;simpleschema&#x27;)
  , MongoSchemaMixin = require(&#x27;simpleschema/MongoSchemaMixin.js&#x27;)

  , JsonRestStore = require(&#x27;jsonreststores&#x27;)
  , MongoDriverMixin = require(&#x27;jsonreststores/MongoDriverMixin.js&#x27;)

  , declare = require(&#x27;simpledeclare&#x27;)

  , hotCoreJsonRestStores = require( &#x27;hotCoreJsonRestStores&#x27; )
;


// Some sane defaults

// Multihome enabled
hotplate.config.set(&#x27;hotCoreMultiHome&#x27;, {
   enabled: true,
   multiHomeURL: &#x27;/wssssssssssssssssssss/:workspaceId&#x27;, // MUST contain :workspaceId
   escapePick: true,
});


hotplate.hotEvents.on( &#x27;stores&#x27;, &#x27;hotCoreMultiHome&#x27;, function( done ){

  var stores = {};

  hotCoreJsonRestStores.getJsonRestStoresMixins( function( err, mixins ){
    if( err ){
      done( err );
    } else {

      var Store = declare( [ JsonRestStore, MongoDriverMixin, mixins.StoreMixin ]  );
      var Schema = declare( [ SimpleSchema, MongoSchemaMixin, mixins.SchemaMixin ] );

      // ***********************************
      // *** WORKSPACES ********************
      // ***********************************

      stores.Workspaces = declare( Store, {

        // COMMON
        schema: new Schema({
          _id:           { type: &#x27;id&#x27; },
          workspaceName: { type: &#x27;string&#x27;, searchable: true, searchPartial: false,
                         sortable: false, notEmpty: true, sharedValidator: &#x27;workspaceValidator&#x27;, trim: 128 },
          ownerUserId:   { type: &#x27;id&#x27; }, 
        }
        // #2
        ),

        handlePost: true,
        checkPermissionsPost: function( params, body, options, cb ){
          // Needs to be logged in
          if( ! this._req.session.userId ) return cb( null, false );
     
          // Make sure that body.ownerUserId IS indeed the logged in user
          body.ownerUserId = this._req.session.userId;

          cb( null, true );
        },

      // #1

        storeName:  &#x27;workspaces&#x27;,
        paramIds: [ &#x27;_id&#x27; ],

      // #5

        // If creating a new workspace, and the user is logged in, then
        // assign the creating user to that workspace
        afterPost: function( params, body, options, doc, fullDoc, cb ){

          if( this.remote &amp;&amp; this._req.session.loggedIn ){
            var userId = this._req.session.userId;
            if( userId ){
               // Note: this calls the callback
               stores.WorkspaceUsers.Post( { userId: userId, workspaceId: doc._id }, {}, cb );
            } else {
              cb( null );
            }
          }
        },
        publicURL: &#x27;/workspaces/&#x27;,

      });


/*
  var WorkspaceInvites = exports.WorkspaceInvites = declare( Store, {

    schema: new Schema({
      workspaceId: { type: &#x27;id&#x27; },
      inviteCode:  { type: &#x27;string&#x27; },
      email     :  { type: &#x27;string&#x27; },
      name      :  { type: &#x27;string&#x27; },
      _id:         { type: &#x27;id&#x27; },
    }),

    handlePut: false,
    handlePost: true,
    handleGet: true,
    handleGetQuery: true,
    handleDelete: true,

    searchSchema: new Schema({
      workspaceId: { type: &#x27;id&#x27; },
      userId:      { type: &#x27;id&#x27; },
      _id:         { type: &#x27;id&#x27; },
    }),

    storeName:  &#x27;workspaceInvites&#x27;,
    paramIds: [ &#x27;workspaceId&#x27;, &#x27;_id&#x27; ],
    publicURL: &#x27;/workspaces/:workspaceId/invites/&#x27;,
  });
  //WorkspaceInvites.onlineAll( app, &#x27;/workspaces/:workspaceId/invites&#x27;, &#x27;:_id&#x27; );
*/


      // The basic schema for the WorkspaceUsers table
      stores.WorkspacesUsersBase = declare( Store, {

        schema: new Schema({
          userId:      { type: &#x27;id&#x27; },
          workspaceId: { type: &#x27;id&#x27; },
          _id:         { type: &#x27;id&#x27; },
        }),

        storeName: &#x27;workspacesUsersBase&#x27;,
        collectionName: &#x27;workspaceUsers&#x27;,

        paramIds: [ &#x27;_id&#x27; ],
      });


      stores.WorkspaceUsers = declare( stores.WorkspacesUsersBase, {

        searchSchema: new Schema({
          workspaceId: { type: &#x27;id&#x27; },
          userId:      { type: &#x27;id&#x27; },
          _id:         { type: &#x27;id&#x27; },
        }),

        storeName:  &#x27;workspaceUsers&#x27;,
        paramIds: [ &#x27;workspaceId&#x27;, &#x27;_id&#x27; ],
        publicURL: &#x27;/workspaces/:workspaceId/users/&#x27;,
      });

      stores.UserWorkspaces = declare( stores.WorkspacesUsersBase, {

        searchSchema: new Schema({
          userId:        { type: &#x27;id&#x27; },
          workspaceId:   { type: &#x27;id&#x27; },
          _id:           { type: &#x27;id&#x27; },
         // workspaceName: { EXTERNAL FROM workspaces } 
        }),

        storeName:  &#x27;userWorkspaces&#x27;,
        paramIds: [ &#x27;userId&#x27;, &#x27;_id&#x27; ],

        handleGetQuery: true,
        checkPermissionsGetQuery: function( params, body, options, cb ){
          // Only their own strategies
          if( this._req.session.userId != params.userId ) return cb( null, false );
          cb( null, true );
        },


        // Get the much needed workspaceName from the Workspaces table
        prepareBeforeSend: function( doc, cb ){

          var self = this;

          stores.Workspaces.Get( doc.workspaceId, {}, function( err, otherDoc ){
            self._sendErrorOnErr( err, cb, function(){

              doc.workspaceName = otherDoc.workspaceName;
              cb( null, doc );
            })
          })

        },

        publicURL: &#x27;/users/:userId/workspaces/&#x27;,

      });

      // done( null, stores );
      done( null,  [ stores.Workspaces, stores.WorkspaceUsers, stores.UserWorkspaces ] );

    }
  })


});



// Place relevant config variables on the rendered page
hotplate.hotEvents.on( &#x27;pageElements&#x27;, &#x27;hotCoreMultiHome&#x27;, function( done ){

  done( null, {
    vars:  [
             { name: &#x27;enabled&#x27;,      value: hotplate.config.get(&#x27;hotCoreMultiHome.enabled&#x27;) },
             { name: &#x27;multiHomeURL&#x27;, value: hotplate.config.get(&#x27;hotCoreMultiHome.multiHomeURL&#x27;) },
           ],
  });
});

// Place workspaceId on the rendered page
hotplate.hotEvents.on( &#x27;pageElementsPerPage&#x27;, &#x27;hotCoreMultiHome&#x27;, function( elements, req, pageName, done ){

  var vars = [];

  // Add the user ID to the page as a variable
  if( req.params.workspaceId ){
    vars.push( { name: &#x27;workspaceId&#x27;, value: req.params.workspaceId } );
  }

  done( null, {
    vars: vars
  });

});


    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
