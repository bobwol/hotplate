define(['dojo/Deferred', 'dojo/ready', 'dojo/topic' ], function (Deferred , ready, topic ) {
 
  return {
    deferredMap: {},
    subscribersCount: {},

    _getDeferredForTopic: function (topicString) {
      if (!this.deferredMap[topicString]) {
        this.deferredMap[topicString] = new Deferred();
      }
      return this.deferredMap[topicString];
    },

    incSubscriber: function (topicString) {
      if( typeof( this.subscribersCount[topicString] ) === 'undefined' ) this.subscribersCount[topicString] = 0;
      this.subscribersCount[topicString] ++;
    },

    publishWhenReady: function(topicString) {
      var args = arguments;
      self = this;

      // This will guarantee that every single plugin has been called
      //ready( function() {

        if( typeof( self.subscribersCount[topicString]) === 'undefined' || self.subscribersCount[topicString] == 0 ){
          topic.publish.apply(self, args);
        } else {
          self._getDeferredForTopic(topicString).then(function () {
            topic.publish.apply(self, args);
          });
        }
      //})
    },

    ready: function (topicString) {
      self = this; 
      ready( function() { 
        self.subscribersCount[topicString] --;

        if( self.subscribersCount[topicString] < 0 ){
          throw( new Error("Subscriber count < 0" ) );
        }

        if( ! self.subscribersCount[topicString]){ 
          self._getDeferredForTopic(topicString).resolve();
        }
      });
    }
  };
}); 
