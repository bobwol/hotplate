
var util = require('util')
  , fs = require('fs')
  , hotplate = require('hotplate')
  , mongoose = require('mongoose')
  , app = hotplate.app
;


// Module's variables
var logModel = {};
var schemaObject = {};


exports.hotHooks = hooks = {}

hooks.postInit = function(){

  // Get all logFields from all modules, creating schemaObject
  hotplate.invokeAll('logFields').forEach(function(entry){
    var result = entry.result;
    for(var k in result){
      schemaObject[k] = result[k];
    }
  });

  // Create logModel based on schemaObject
  logModel = mongoose.model('Log' , new mongoose.Schema( schemaObject ) ); 
}


hooks.log = function(entry){

  // Create the model
  var log = new logModel();

  // Cycle through the data to be logged...
  for(var k in entry){

    // If it's set to be serialised, to so.
    if( schemaObject[k] && schemaObject[k].serialize  ){
      entry[k] = JSON.stringify(entry[k]);
    }

    // Assign it.
    log[k] = entry[k];
  }

  // Save the record.
  log.save();

}

