define([
  'dojo/_base/declare',
  'dijit/form/ValidationTextBox',

  'hotplate/hotDojoWidgets/_AjaxValidatorMixin',
  'hotplate/hotDojoStores/stores',
  ], function(
    declare

  , ValidationTextBox
  , _AjaxValidatorMixin
  , stores
  ){
    return declare('hotplate.hotDojoAuth.ValidationUsername',  [ ValidationTextBox, _AjaxValidatorMixin ], {

      ajaxOkWhen: 'present',
      ajaxInvalidMessage: 'Ajax check failed',

      validator: function(value){

        var Validators = sharedFunctions.hotSharedValidators;

        // Run the normal field validators -- if they fail,
        // return false
        var validation =  Validators.login(value);
        if( ! validation.result ){
          this.invalidMessage = validation.message;
          return false;
        }

        return this.ajaxValidate(value, {
           ajaxInvalidMessage: this.ajaxInvalidMessage,
           ajaxStore: stores('usersAnon'),
           ajaxFilterField: 'login',
           ajaxOkWhen: this.ajaxOkWhen,
        });

      },

      invalidMessage: "Username not valid",
      missingMessage: "Username cannot be empty",

    });
  }
);
