
define([
  "dojo/_base/declare",
  "dojo/topic",
  "dojo/aspect",
  "hotplate/hotDojoStores/stores",
  "hotplate/hotMessages/messages",
  "hotplate/bd/AppStoreNotify", // NEEDS TO BE CALLED BEFORE THIS ONE

  "dojo/domReady!",
   ], function(
   declare
 , topic
 , aspect
 , stores
 , messages
 ){


  var r = {};
  var userConfigStore      = stores('userConfig',      { workspaceIdCall: vars['hotDojoAppContainer']['workspaceId'] } ),
      workspaceConfigStore = stores('workspaceConfig', { workspaceIdCall: vars['hotDojoAppContainer']['workspaceId'] } ),
      accessConfigStore    = stores('accessConfig',    { workspaceIdCall: vars['hotDojoAppContainer']['workspaceId'] } );

  userConfigStore.memCache.put( vars.bd.userConfig );
  workspaceConfigStore.memCache.put( vars.bd.workspaceConfig );
  accessConfigStore.memCache.put( vars.bd.accessConfig );

  // Assign the config variables
  r.userConfig = vars.bd.userConfig;
  r.workspaceConfig = vars.bd.workspaceConfig;
  r.accessConfig = vars.bd.accessConfig;

  // Watch for changes
  topic.subscribe('storeChange', function( storeName, objectId ){
    if( storeName === 'userConfig' && objectId === userId ){
      r.userConfig = userConfigStore.memCache.get(userId);
      topic.publish('configChange/user', r.userConfig );
      console.log("userConfig refreshed");
    }
  });

  topic.subscribe('storeChange', function( storeName, objectId ){
    if( storeName === 'workspaceConfig' && objectId === workspaceId ){
      r.workspaceConfig = workspaceConfigStore.memCache.get(workspaceId);
      topic.publish('configChange/workspace', r.workspaceConfig );
      console.log("workspaceConfig refreshed");
    }
  });

  topic.subscribe('storeChange', function( storeName, objectId){
    if( storeName === 'accessConfig' && objectId === userId ){
      r.accessConfig = accessConfigStore.memCache.get(userId);
      topic.publish('configChange/access', r.accessConfig );
      console.log("accessConfig refreshed");
    }
  });



  /*
  aspect.after(userConfigStore.memCache, 'put', function(item){
    if( item._id === 'self'){
      topic.publish('configChange/user', item );
    }
  }, true);

  aspect.after(workspaceConfigStore.memCache, 'put', function(item){
    if( item._id === 'self'){
      r.workspaceConfig = workspaceConfigStore.memCache.get('self');
      topic.publish('configChange/workspace', item );
    }
  }, true);

  aspect.after(accessConfigStore.memCache, 'put', function(item){
    if( item._id === 'self'){
      r.accessConfig = accessConfigStore.memCache.get('self');
      topic.publish('configChange/access', item );
    }
  }, true);
  */

  return r;

});


