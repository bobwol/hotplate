
define([
  "dojo/_base/declare",
  "dojo/topic",
  "dojo/when",
  "dojo/aspect",
  "hotplate/hotDojoStores/stores",
  "hotplate/hotMessages/messages",
  "hotplate/bd/AppStoreNotify", // NEEDS TO BE CALLED BEFORE THIS ONE

  "dojo/domReady!",
   ], function(
   declare
 , topic
 , when
 , aspect
 , stores
 , messages
 ){


  var r = {};
  var userConfigStore      = stores('userConfig',      { workspaceIdCall: vars['hotDojoAppContainer']['workspaceId'] } ),
      workspaceConfigStore = stores('workspaceConfig', { workspaceIdCall: vars['hotDojoAppContainer']['workspaceId'] } ),
      accessConfigStore    = stores('accessConfig',    { workspaceIdCall: vars['hotDojoAppContainer']['workspaceId'] } );

  userConfigStore.memCache.put( vars.bd.userConfig, { dontPublish: true }  );
  workspaceConfigStore.memCache.put( vars.bd.workspaceConfig, { dontPublish: true }  );
  accessConfigStore.memCache.put( vars.bd.accessConfig, { dontPublish: true }  );

  // Assign the config variables
  r.userConfig = vars.bd.userConfig;
  r.workspaceConfig = vars.bd.workspaceConfig;
  r.accessConfig = vars.bd.accessConfig;

  // Watch for changes
  topic.subscribe('storeChange', function( from, message){
    if( message.storeName === 'userConfig' && message.objectId === userId ){
      if( message.remote ) userConfigStore.memCache.put( message.object, { dontPublish: true } );
      r.userConfig = message.object;
      topic.publish('configChange/user', r.accessConfig );
    }
  });




  topic.subscribe('storeChange', function( from, message ){
    if( message.storeName === 'workspaceConfig' && message.objectId === workspaceId ){
      r.workspaceConfig = workspaceConfigStore.memCache.get(workspaceId);
      topic.publish('configChange/workspace', r.workspaceConfig );
      console.log("workspaceConfig refreshed");
    }
  });

  topic.subscribe('storeChange', function( from, message ){
    console.log("ARGUMENTS 2:");
    console.log(arguments);
    if( message.storeName === 'accessConfig' && message.objectId === userId ){
      console.log("GOT HERE");


      console.log("accessConfig refreshed");
    }
  });



  /*
  aspect.after(userConfigStore.memCache, 'put', function(item){
    if( item._id === 'self'){
      topic.publish('configChange/user', item );
    }
  }, true);

  aspect.after(workspaceConfigStore.memCache, 'put', function(item){
    if( item._id === 'self'){
      r.workspaceConfig = workspaceConfigStore.memCache.get('self');
      topic.publish('configChange/workspace', item );
    }
  }, true);

  aspect.after(accessConfigStore.memCache, 'put', function(item){
    if( item._id === 'self'){
      r.accessConfig = accessConfigStore.memCache.get('self');
      topic.publish('configChange/access', item );
    }
  }, true);
  */

  return r;

});


