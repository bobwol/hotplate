
define([
  "dojo/_base/declare",
  "dojo/_base/json",
  "dojo/store/Observable",
  "dojo/topic",
  "dojo/on",
  "dojo/dom",
  "dojo/dom-class",
  "dojo/when",
  "dojo/store/Memory",

  "dijit/_WidgetBase",
  "dijit/_TemplatedMixin",
  "dijit/_WidgetsInTemplateMixin",
  "dijit/form/Form",
  'dijit/layout/TabContainer',
  'dijit/layout/ContentPane',
  "dijit/Destroyable",

  'dgrid/OnDemandGrid',
  'dgrid/OnDemandList',
  'dgrid/Keyboard',
  'dgrid/Selection',
  'dgrid/_StoreMixin',

  "hotplate/hotDojoSubmit/defaultSubmit",
  "hotplate/hotDojoLogger/logger",
  "hotplate/hotDojoStores/stores",

  "hotplate/hotDojoWidgets/AlertBar",
  "hotplate/hotDojoWidgets/_OverlayMixin",
  "hotplate/hotDojoWidgets/BusyButton",


   ], function(
     declare
     , json
     , Observable
     , topic
     , on
     , dom
     , domClass
     , when
     , Memory

     , _WidgetBase
     , _TemplatedMixin
     , _WidgetsInTemplateMixin
     , Form
     , TabContainer
     , ContentPane
     , Destroyable

     , OnDemandGrid
     , OnDemandList
     , Keyboard
     , Selection
     , _StoreMixin

     , ds
     , Logger
     , stores

     , AlertBar
     , _OverlayMixin
     , BusyButton

 ){


  var AdminTabContainer = declare('hotplate/bd/AdminTabContainer', [ ContentPane, _TemplatedMixin, _WidgetsInTemplateMixin ], {

    widgetsInTemplate: true,

    templateString: '' +
      '<div class="adminSection" >' +
      '  <div data-dojo-attach-point="widget" data-dojo-type="dijit/layout/ContentPane">' +
      '    <div data-dojo-type="dijit/layout/TabContainer" data-dojo-props="tabPosition: \'top\'" data-dojo-attach-point="settingsTab">' +
      '      <div data-dojo-type="hotplate/bd/AdminWorkspaceSettings" data-dojo-props="title:\'General\'"></div>' + 
      '      <div data-dojo-type="hotplate/bd/AdminLogs" data-dojo-attach-point="logs" data-dojo-props="title: \'Logs\'"></div>' +
      '    </div>' +
      '  </div>' +
      '</div>',
  });





  declare('hotplate/bd/AdminLogs', [ContentPane, _TemplatedMixin, _WidgetsInTemplateMixin ], {

    widgetsInTemplate: true,

    templateString: '' +
      '<div>' +
      '  <div data-dojo-type="hotplate.hotDojoWidgets.AlertBar" data-dojo-attach-point="alertBar"></div>' +
      '  <div id="grid"></div>' + 
      '</div>',

    postCreate: function(){
      this.inherited(arguments);
      var that = this;
    }, // postCreate


    onShow: function(){
      this.inherited(arguments);
      console.log("Shown!");
    },


    startup: function(){

      this.inherited(arguments);

      var customGrid = declare( [OnDemandGrid, Keyboard, Selection, _OverlayMixin ]);    

      var grid = new customGrid({
        columns: {
          loggedOn: "Logged On",
          data: "Data",
          errorName: 'Error name',
          logLevel: "Log level",
          message: "Message",
          _id: "ID",
        },
        // selectionMode: "extended",
        cellNavigation: true,
        // store: stores('logs:data', { workspaceIdCall: vars['hotDojoAppContainer']['workspaceId'] } ) ,
        store: new Memory( { data: {} } ),
        query: {} , //  data: 'pp' },
        // query: {errorName: 'Refe', logLevel: 0 },
        sort: [
          { attribute: 'logLevel', descending: true },
          { attribute: 'data', descending: true },
        ],

      }, "grid");

      grid.refresh();

      grid.on('dgrid-error', function(event){
        topic.publish( 'globalAlert', 'Dgrid error: ' + event.error.message, 5000 );
        // grid.set('overlayed', true);
        // grid.set('overlayClickable', true);
      });

      grid.onOverlayClick = function(event){
        grid.refresh();
        grid.set('overlayed', false );
      };

    },

      
  });


  declare('hotplate/bd/AdminWorkspaceSettings', [ ContentPane, _TemplatedMixin, _WidgetsInTemplateMixin, _OverlayMixin ], {

    templateString: '' +
      '<div>' +
      '  <form data-dojo-type="dijit/form/Form" data-dojo-attach-point="formWidget" method="POST"> ' +
      '    <div data-dojo-type="hotplate.hotDojoWidgets.AlertBar" data-dojo-attach-point="alertBarWidget"></div>' +

      '    <input type="hidden" data-dojo-type="dijit/form/TextBox" name="_id" />' +
      '    <input type="hidden" data-dojo-type="dijit/form/TextBox" name="__v" />' +

      '    <div class="box"><p class="boxTitle">Workspace information</p>' +

      '      <div class="inputField" style="display:inline-block; margin-right:30px">' +
      '        <label for="${id}_WorkspaceLongName">Workspace name</label>' +
      '        <input id="${id}_WorkspaceLongName" data-dojo-type="dijit/form/ValidationTextBox" style="width:10em;" maxlength="50" name="longName" data-dojo-props="required:true" />' + 
      '      </div>' +
      '      <div class="inputField" style="display:inline-block;">' +
      '        <label for="${id}_WorkspaceTag">Workspace\'s tag line</label>' +
      '        <input id="${id}_WorkspaceTag" data-dojo-type="dijit/form/ValidationTextBox" style="width:40em" maxlength="150" name="tag" data-dojo-props="required: true"/>' +
      '      </div>' +

      '    </div>' +
      '    <input class="formSubmit" type="submit" data-dojo-attach-point="buttonWidget" data-dojo-type="hotplate/hotDojoWidgets/BusyButton" label="Update" />' +
      '  </form>' +
      '</div>',


    // The store for records
    recordStore: null,


    postCreate: function(){
      this.inherited(arguments);

      var that = this;

      // Sets the record store for the widget
      this.recordStore = stores('workspaceConfig', { workspaceIdCall: vars['hotDojoAppContainer']['workspaceId'] } );

      // When the form's overlay is clicked, try and show the form again
      on(this, 'overlayClick', function(e){
        this.onShow();
      });

 
      // Submit form, trying to save values
      this.formWidget.onSubmit = ds.defaultSubmit(this.formWidget, this.buttonWidget, function(){

        // Set the values about to be saved
        var formValues = that.formWidget.get('value');

        // Try to save the values
        when( that.recordStore.put( formValues )) .then(
          ds.UIMsg( that.buttonWidget, that.alertBarWidget, 'Configuration saved!' ),
          ds.UIErrorMsg( that.formWidget, that.buttonWidget, that.alertBarWidget )
        ).then( function( res ) {
           // ...
        });

      }); // this.formWidget.onSubmit
    }, // postCreate()


    onShow: function(){

      var that = this;

      // By default, this widget is overlayed
      this.set( 'overlayed', true );
      this.set( 'overlayClickable', false );

      when( this.recordStore.get( workspaceId )).then(
        ds.UIMsg(),
        ds.UIErrorMsg()
      ).then(
        function(res){

          // OK things worked out: the overlay can go, values are assigned to form
          that.set( 'overlayed', false );
          that.formWidget.set( 'value', res ); // Thanks Karl Tiedt :D

        },
        function(err){
          that.set('overlayClickable', true );
        }
      );

    },



  }); // declare('hotplate/bd/SettingsGeneral'


 return AdminTabContainer;
});



