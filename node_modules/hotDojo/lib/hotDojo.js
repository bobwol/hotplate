var 
  hotplate =  require('hotplate')
, path = require('path')
;

exports.hotHooks = hooks = {}

hooks.run = function( done ){
  done( null );
}


hooks.pageElements = function( done ){

  var conf = hotplate.get('hotDojoConfig');
  var headlines, dojoConfigAssign;

  // *********************
  // *** SANE DEFAULTS ***
  // *********************
  if( typeof( conf ) === 'undefined' ){
    conf = {};
  }

  if( typeof( conf.dojoConfig ) === 'undefined' ){
    conf.dojoConfig = { };
  }

  // Assign important defaults to dojoConfig:
  //  * needs to be asyncronous, AND
  //  * needs to have the package "hotplate" set
  //  * needs to have a "local" blank.html file configured via dojoBlankHtmlUrl
  conf.dojoConfig.async = 1;
  if( ! Array.isArray( conf.dojoConfig.packages ) ) conf.dojoConfig.packages = [];
  conf.dojoConfig.packages.push( { name: 'hotplate', location: hotplate.get( 'staticUrlPath' ) } );
  conf.dojoConfig.dojoBlankHtmlUrl = path.join( hotplate.get( 'staticUrlPath' ), 'hotDojo', 'blank.html' );


  if( typeof( conf.dojoUrl ) === 'undefined' ){
    conf.dojoUrl = "//ajax.googleapis.com/ajax/libs/dojo/1.8.1/dojo/dojo.js";
  }

  if( typeof( conf.cssUrl ) === 'undefined' ){
    conf.cssUrl = "//ajax.googleapis.com/ajax/libs/dojo/1.8.3/dijit/themes/claro/claro.css";
  }

  hotplate.invokeAll( 'enrichDojoConf', conf, function( err, results ){

    if(err){
      done( err );
    } else {

      // Make up the string to add to the page
      dojoConfigAssign = "<script>dojoConfig = " + JSON.stringify( conf.dojoConfig ) + "</script>"; // MAYBE ADD replace(/\//g,'\\/').

      headlines = [
        dojoConfigAssign,
        '<script src="' + conf.dojoUrl + '"></script>',
        '<link type="text/css" rel="stylesheet" href="' + conf.cssUrl + '" media="screen" />',
      ];

      done( null, { moduleName: 'hotDojo', result: { headLines: headlines } } );

    }
  });

  

  /* 
  // Get Dojo from a CDN
  if( ! conf.type || conf.type === 'cdn' ){
    headlines = [
      //"<script data-dojo-config=\"async: 1, baseUrl: '//', dojoBlankHtmlUrl: '/blank.html'\", src=\"//ajax.googleapis.com/ajax/libs/dojo/1.8.1/dojo/dojo.js\"></script>",
      "<script>dojoConfig = {async: 1, baseUrl: '//', dojoBlankHtmlUrl: '/blank.html' }</script>",
      "<script src=\"//ajax.googleapis.com/ajax/libs/dojo/1.8.1/dojo/dojo.js\"></script>",
      '<link type="text/css" rel="stylesheet" href="//ajax.googleapis.com/ajax/libs/dojo/1.8.3/dijit/themes/claro/claro.css" media="screen" />',
    ];
  }
  */
     


      // '<script data-dojo-config="async: 1, dojoBlankHtmlUrl: \'/blank.html\', packages: [ { name: \'hotplate\', location: location.pathname.replace(/\\/[^/]+$/, \'\') + \'/hotplate\' } ]" src="//ajax.googleapis.com/ajax/libs/dojo/1.8.1/dojo/dojo.js"></script>',

      //"<script data-dojo-config=\"async: 1, dojoBlankHtmlUrl: '/blank.html', packages: [ { name: 'hotplate', location: location.pathname.replace(/\\/[^/]+$/, '') + '/hotplate' } ]\" src=\"//ajax.googleapis.com/ajax/libs/dojo/1.8.1/dojo/dojo.js\"></script>",
     
      //"<script data-dojo-config=\"async: 1, baseUrl: '//', dojoBlankHtmlUrl: '/blank.html', packages: [ { name: 'hotplate', location: '" + hotplate.get( 'staticUrlPath' )+ "' } ]\" src=\"//ajax.googleapis.com/ajax/libs/dojo/1.8.1/dojo/dojo.js\"></script>",


      //'<link type="text/css" rel="stylesheet" href="/dojo/dijit/themes/claro/claro.css" media="screen" />',
      //'<script type="text/javascript" src="/dojo/dojo/dojo.js" data-dojo-config="parseOnLoad: false, async:true,isDebug:false, cacheBust:false"></script>',

      //'<script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/dojo/1.8.3/dojo/dojo.js" data-dojo-config="parseOnLoad: false, async:true,isDebug:false, cacheBust:false"></script>',

      //'<script>var dojoConfig= { async: true,   packages: [ { name: "hotplate", location: "/hotplate" }] }; </script>' // location.pathname.replace(/\/[^/]*$/, "") }] } </script>'

}


// Simply activate path to client files
hooks.clientPaths = function( done ){
  done( null, { moduleName: 'hotDojo', result: [ path.join(__dirname, '../client') ] } );
}


