"use strict";

/*!
 * Module dependencies.
 */

var
  hotplate = require('hotplate')
, hotCoreStoreRegistry = require( 'hotCoreStoreRegistry' )
;

hotplate.config.set( 'hotCoreStoreIndexer.zapIndexes', false );

hotplate.hotEvents.on( 'run', hotplate.cachable( function( done ){

  hotCoreStoreRegistry.getAllStores( function( err, allStores ){  
    
    Object.keys( allStores.stores ).forEach( function( storeName ){
 
      var storeEntry = allStores.stores[ storeName ];

      if( hotplate.config.get( 'hotCoreStoreIndexer.zapIndexes' ) ){

        hotplate.logger.warn("Zapping indexes before rebuilding them for ", storeName);

        storeEntry.storeObject.dropAllIndexes( function( e ){
          storeEntry.storeObject.makeIndexes( { background: true } );
        });
      } else {
        storeEntry.storeObject.makeIndexes( { background: true } );
      }

    });

    done( null );
  });
}));

