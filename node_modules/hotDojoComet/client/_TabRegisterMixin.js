define( [

  "dojo/_base/declare"

, "hotplate/hotDojoStores/stores"
, 'hotplate/hotDojoGlobals/globals'
, "hotplate/hotDojoWidgets/_OverlayMixin"
, "hotplate/hotDojoComet/messages"

], function(

  declare

, stores
, globals
, _OverlayMixin
, messages

){

  return declare( [ _OverlayMixin ], {

    postCreate: function(){
      var self = this;
      
      this.inherited(arguments);

      // Throw if more than one widget inherits
      if( window._registrationRun ){
        throw( new Error("Only ONE widget can inherit from _TabRegisterMixin!") );
      } 
      window._registrationRun = true;

      // Make sure registerForMessages() is successful with overlay
      // (User will click on overlay to retry)
      this.set( 'overlayed', true );
      this.set( 'overlayClickable', false );
      registerForMessages();
      //
      this.on( 'overlayClick', function( e ){
        registerForMessages();
      });
      //
      function registerForMessages(){
        messages.register().then(
          function( res ){
            self.set( 'overlayed', false );
          },
          function( err ){
            self.set( 'overlayClickable', true );
          }
        );
      };

      window.onbeforeunload = function( e ) {
        messages.unregister();
      }
 
    },

  });

});


