"use strict";

var 
  hotplate =  require('hotplate')
, path = require('path')
;


// Some defaults to get things going
//  * needs to be asyncronous, AND
//  * needs to have the package "hotplate" set
//  * needs to have a "local" blank.html file configured via dojoBlankHtmlUrl
hotplate.config.set( 'hotDojoAdd.dojoConfig', {
  packages: [
    {
      name: 'hotplate',
      location: hotplate.config.get( 'hotplate.staticUrlPath' ),
    },
  ],
  dojoBlankHtmlUrl: path.join( hotplate.config.get( 'hotplate.staticUrlPath' ), 'hotDojo', 'blank.html' ),
  async: 1,
});

// By default, take Dojo from the CDN. It will always work. Developers will set
// a direct path for Dojo in their local machine so that debugging is easier
hotplate.config.set( 'hotDojoAdd.dojoUrl', "//ajax.googleapis.com/ajax/libs/dojo/1.8.3/dojo/dojo.js.uncompressed.js" );
hotplate.config.set( 'hotDojoAdd.cssUrl',  "//ajax.googleapis.com/ajax/libs/dojo/1.8.3/dijit/themes/claro/claro.css" );


hotplate.hotEvents.on( 'pageElements', 'hotDojoAdd', hotplate.cachable( function( done ){

  var headLines, dojoConfigAssign;

  hotplate.hotEvents.emit( 'enrichDojoConf', hotplate.config.get( 'hotDojoAdd.dojoConfig'), function( err, results ){

    if(err){
      done( err );
    } else {

      // Make up the string to add to the page
      dojoConfigAssign = "<script>dojoConfig = " + JSON.stringify( hotplate.config.get( 'hotDojoAdd.dojoConfig') ) + "</script>"; // MAYBE ADD replace(/\//g,'\\/').

      headLines = [
        dojoConfigAssign,
        '<script src="' + hotplate.config.get( 'hotDojoAdd.dojoUrl' ) + '"></script>',
        '<link type="text/css" rel="stylesheet" href="' + hotplate.config.get( 'hotDojoAdd.cssUrl' ) + '" media="screen" />',
      ];

      done( null, { headLines: headLines } );
    }
  });

}));

hotplate.hotEvents.on( 'pageElementsPerPage', 'hotDojoAdd', function( elements, req, pageName, done ){

  hotplate.hotEvents.emit( 'dojoModulesPerPage', req, pageName, function( err, dojoModules ){
    if( err ){
      done( err );
    } else {

      var result = '';

      result += '<script>\n';
      result += '  // Modules marked as to be loaded by hotplate\n';
      result += '  require(["dojo/topic",';

      // Make up the list of modules as a comma separated string, depending on what returned
      var listAsArray = [];
      dojoModules.forEach( function( moduleInfo ){
        moduleInfo.result.forEach( function( moduleResult ){
          listAsArray.push( '"' + path.join( 'hotplate', moduleInfo.module, moduleResult) + '"');
        });
      });
      result += listAsArray.join() + '], function(topic){\n';

      result += '\n';
      result += '    // This topic will tell hotplate modules that everything has been loaded up\n';
      result += '    topic.publish( "hotplateModulesLoaded" );\n';
      result += '  })\n';
      result += '</script>\n';

      done( null, { headLines: [ result ] } );
    }
  });
});

/*
// This is only cachable so that it cannot happen twice
hotplate.hotEvents.on( 'setRoutes', hotplate.cachable( function( app, done ){

  // Defines the route [staticUrlPath]/hotCoreSharedCode/shares.js which will
  // return the javascript which will define an object variable called
  // sharedFunctions containing all the defined validation functions
  // (divided by module)
  var dojoModulesLoader = path.join( hotplate.config.get('hotplate.staticUrlPath'), 'hotDojoAdd', 'dojoModules.js');

  app.get( dojoModulesLoader, function(req, res ){
    res.send( result );
  });
  done( null );
    }
  });
}));
*/


/*
// Make the file "shared.js" visible and shared.
hotplate.hotEvents.on('pageElements', 'hotDojoAdd', function( done ){

  done( null, {
    jses: [ 'dojoModules.js' ]
  });

});
*/

// Simply activate path to client files
hotplate.hotEvents.on( 'clientPaths', 'hotDojo', function( done ){
  done( null, [ path.join(__dirname, '../client') ] );
})

