/*!
 * Module dependencies.
 */

var util = require('util')
  , hotplate = require('hotplate')
  , path = require('path')
;


hotplate.hotEvents.on( 'setRoutes', function( done ){

  // Defines the route [staticUrlPath]/hotCoreSharedCode/shares.js which will
  // return the javascript which will define an object variable called
  // sharedFunctions containing all the defined validation functions
  // (divided by module)
  var sharedFunctionsLocation = path.join( hotplate.get('staticUrlPath'), 'hotCoreSharedCode', 'shared.js');


  hotplate.hotEvents.emit( 'sharedFunctions', function( err, sharedFunctions ){
    if( err ){
      done( err );
    } else {

      hotplate.app.get( sharedFunctionsLocation, function(req, res ){
        var result = '';

        // Define the variable as an associative array
        // WATCH OUT: needs to end with "\n " so that comma-clipping works even
        // if there is nothing in the rendered object
        result += "var sharedFunctions = { \n ";
    
        // Cycle through every module defined...
        sharedFunctions.forEach( function( item ){
          var moduleName = item.module;
          var sharedFunctions = item.result;

          // WATCH OUT: needs to end with "\n " so that comma-clipping works even
          // if there is nothing in the rendered object
          result += moduleName + ": {\n ";
          for(functionName in sharedFunctions ){
            if( typeof( sharedFunctions[functionName] ) === 'function' ){
              result += functionName + ": " + sharedFunctions[functionName] + ",\n";
            }
          }
          // Clip the last comma and close the variable
          result = result.substring(0, result.length -2 ) + "\n";
          result += "},\n";
        });

        // Clip the last comma and close the main associative array
        result = result.substring(0, result.length -2 ) + "\n";
        result += "}\n";

        res.send(result);
      });

      done( null );
    }
  });

})


// Make the file "shared.js" visible and shared.
hotplate.hotEvents.on('pageElements', 'hotCoreSharedCode', function( done ){

  done( null, {
    jses: [ 'shared.js' ]
  });

});

