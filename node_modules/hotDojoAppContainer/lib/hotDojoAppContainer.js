
var dummy
  , path = require( 'path' )
  , hotplate = require( 'hotplate' )
  , hotCoreStoreRegistry = require('hotCoreStoreRegistry')
  , logger = require('hotCoreServerLogger');
;

// Add routes for the multiHomeURL and for appURL depending on
// hotplate's hotCoreAuth configuration

hotplate.hotEvents.on( 'setRoutes', function( done ){

  var hotCoreMultiHome = hotplate.get('hotCoreMultiHome');
  var hotCoreAuth = hotplate.get('hotCoreAuth');

  // Set the multiHome page, or the straight one
  if( typeof( hotCoreMultiHome ) === 'object' && hotCoreMultiHome.enabled ){
    hotplate.app.get( hotCoreMultiHome.multiHomeURL, mainApp);
  } else {
    hotplate.app.get( hotCoreAuth.appURL, mainApp);
  }

  done( null );
}); 

// Send the app page
// Note that workspaceId is not guaranteed to be there -- it's only there
// for multihome environments

function mainApp( req, res, next ){

  var hotCorePage = hotplate.require('hotCorePage');

  // Not logged in: the user must not get this page, redirect to
  // the initial login page instead
  if( ! req.session.loggedIn ){
    res.redirect( hotplate.get('hotCoreAuth/redirectURLs/fail').signin );
  }

  var extraJses = (new hotCorePage.Jses).add( 'hotDojoAppContainer', 'mainContainer.js' );
  var extraCsses = (new hotCorePage.Csses).add( 'hotDojoAppContainer', 'mainContainer.css' );
  var extraVars = new hotCorePage.Vars;
  // extraVars.add( 'hotDojoAppContainer', 'userId', req.session.userId );
  extraVars.add( 'hotDojoAppContainer', 'failURLs', hotplate.get('hotCoreAuth/redirectURLs/fail') );


  // WorkspaceId is not guaranteed to be there -- it's only there for multihome setups
  if( req.params.workspaceId ){
    // extraVars.add( 'hotDojoAppContainer', 'workspaceId', req.params.workspaceId );
    hotCoreStoreRegistry.getAllStores( function( err, allStores ){
      if( err ){
        next( err );
      } else {
        allStores.stores.workspaces.Store.Get( req.params.workspaceId, function( err, record ){
          if( err ){
            next( err );
            //hotplate.get('errorPage')(req, res);
          }  else {
            restOfTheFunction();
          }
        });
      }
    });
  } else {
    restOfTheFunction();
  }
 
  function restOfTheFunction(){ 

    hotCorePage.processPageTemplate(
    {
      jses: extraJses,
      vars: extraVars,
      csses:extraCsses,
      body: '<body class="claro"><div id="appContainer"></div></body>',
    },
    req, 
    'hotDojoAppContainer/container',
    function( err, result ){ 
      if( err ){
        next( err );
        // hotplate.get('errorPage')(req, res);
        logger.log( { message: "ERROR while App container page served" } );
      } else {
        res.send( result );
        logger.log( { message: "App container page served" } );
      }
    }
    );
    return;
  }
  
}

hotplate.hotEvents.on( 'clientPaths', 'hotDojoAppContainer', function( done ){
  done( null, [ path.join( __dirname, '../client' ) ] );
})


