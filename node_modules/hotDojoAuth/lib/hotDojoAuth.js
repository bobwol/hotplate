"use strict";

var dummy
  , hotplate = require('hotplate')
  , path = require('path')
  , hotCoreStoreRegistry = require('hotCoreStoreRegistry')
  , logger = require('hotCoreServerLogger')

  , hotCorePage = require('hotCorePage')
;


hotplate.hotEvents.on( 'setRoutes', hotplate.cachable( function( app, done ){

   // Pages
  app.get('/pages/welcome' , pageWelcome);
  app.get('/pages/pick' , pagePick );

  done( null );
}));

hotplate.hotEvents.on( 'clientPaths', 'hotDojoAuth', function( done ){
  done( null, [ path.join(__dirname, '../client') ] );
})


hotplate.hotEvents.on( 'pageElements', 'hotDojoAuth', function( done ){
  done( null, { csses: [ 'auth.css' ] } );
});


hotplate.hotEvents.on( 'dojoModulesPerPage', 'hotDojoAuth', function( req, pageName, done ){

  switch( pageName ){

    case 'hotDojoAuth/Welcome':
      done( null, [ 'mainWelcome' ] );
    break;

    case 'hotDojoAuth/Pick':
      done( null, [ 'mainPick' ] );
    break;

    default:
      done( null, [] );
    break;
  }

});


var pageWelcome = function(req, res, next){

  req.session =  {};


  // CASE #1: The user IS NOT logged in. Show the straight login form,
  //          after setting the right variables
  if(! req.session.loggedIn){

    // var extraJses = (new hotCorePage.Jses).add('hotDojoAuth', 'mainWelcome.js');
    var extraJses = new hotCorePage.Jses;
    var extraCsses = (new hotCorePage.Csses).add('hotDojoAuth', 'welcome.css');// .add('hotDojoAuth', 'auth.css');
    var extraVars = new hotCorePage.Vars();

    hotCorePage.processPageTemplate(
      {
        jses: extraJses,
        csses: extraCsses,
        vars: extraVars,
        body: '<body class="claro"><div data-dojo-type="hotplate/hotDojoAuth/Welcome" id="welcome"></div>  </body>'
      },
      req,
      'hotDojoAuth/Welcome',
      function( err, result ){
        if( err ){
          next( err );
        } else {
          res.send( result );
          logger.log( { message: "Welcome page served" } );
        }
      }
    );
    return;
  }

  // CASE #2: The user IS logged in. Redirect to pick()
  if( req.session.userId ){
    res.redirect('/pages/pick');
  }

};

var pagePick = function(req, res, next){

  if( req.session.loggedIn){

    var allStores = hotCoreStoreRegistry.getAllStores( function( err, allStores ){

      allStores.stores.userWorkspaces.Store.GetQuery( { filters: { userId: req.session.userId  }  }, function( err, records ){
        if( err ){
          next( err );
        }  else {
        
          // To escape picking, there needs to be exactly 1 workspace AND escapePick needs to be true
          if( records.length !== 1 || ! hotplate.config.get( 'hotCoreMultiHome.escapePick' ) ){
            returnThePage();

          // OK, escape successful! Get the application URL and jump there
          } else {
            var applicationURL = hotplate.config.get( 'hotCoreMultiHome.multiHomeURL' );
            applicationURL = applicationURL.replace( ':workspaceId', records[0].workspaceId );
            res.redirect( applicationURL );
          } 
        }
      });
      
   
      function returnThePage(){
        // var extraJses = (new hotCorePage.Jses).add('hotDojoAuth', 'mainPick.js');
        var extraJses = new hotCorePage.Jses;
        var extraCsses = (new hotCorePage.Csses).add('hotDojoAuth', 'pick.css'); // .add('hotDojoAuth', 'auth.css');
        var extraVars = (new hotCorePage.Vars()).add('hotDojoAuth', 'userId', req.session.userId );

        hotCorePage.processPageTemplate(
          {
            jses: extraJses,
            csses: extraCsses,
            vars: extraVars,
            body: '<body class="claro"><div data-dojo-type="hotplate/hotDojoAuth/Pick" id="pick"></div>  </body>'
          },
          req,
          'hotDojoAuth/Pick',
          function( err, result ){
            if( err ){
              next( err );
            } else {
              res.send( result );
              logger.log( { message: "Pick page served" } );
            }
          }
        );
        return;
      }
    });

  } else {

    var redirectURLs = hotplate.config.get( 'hotCoreAuth.redirectURLs.fail' );
    var redirectURL = redirectURLs[ 'signin' ] || '/' ;
    res.redirect( redirectURL );

  }

};

