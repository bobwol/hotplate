var dummy
  , hotplate = require('hotplate')
  , path = require('path')
;


exports.hotHooks = hooks = {}

hooks.init = function( done ){

  done( null );
}


hooks.pageElements = function( done ){
  done( null, { moduleName: 'hotDojoAuth2', result:{
    csses: [ 'auth.css' ],
  } } );
}


hooks.run = function( done ){

   // Pages
  app.get('/pages/welcome' , pageLogin);
  app.get('/pages/pick' , pagePick );


  done( null );
}

hooks.clientPaths = function( done ){
  done( null, { moduleName: 'hotDojoAuth2', result: [ path.join(__dirname, '../client') ] } );
}


var pageLogin = function(req, res, next){

  var hotCorePage = hotplate.getModule('hotCorePage');
  var logger = hotplate.getModule('hotCoreServerLogger');

  // CASE #1: The user IS NOT logged in. Show the straight login form,
  //          after setting the right variables
  if(! req.session.loggedIn){

    var extraJses = (new hotCorePage.Jses).add('hotDojoAuth2', 'mainWelcome.js');
    var extraCsses = (new hotCorePage.Csses).add('hotDojoAuth2', 'welcome.css');
    var extraVars = new hotCorePage.Vars();

    /*
    extraVars.add( 'hotDojoAuth', 'loggedIn', false );
    extraVars.add( 'hotDojoAuth', 'login',  typeof( req.session.login )  === 'undefined' ? '' : req.session.login );
    extraVars.add( 'hotDojoAuth', 'userId', typeof( req.session.userId ) === 'undefined' ? '' : req.session.userId );
    */

    hotCorePage.processPageTemplate(
      {
        jses:extraJses,
        csses:extraCsses,
        vars:extraVars,
        body: '<body class="claro"> <div data-dojo-type="hotplate/hotDojoAuth2/Welcome" id="welcome"></div>  </body>'
      },
      req,
      'hotDojoAuth/Welcome',
      function( err, result ){
        if( err ){
          hotplate.get('errorPage')(req, res, next);
        } else {
          res.send( result );
          logger.log( { message: "Welcome page served" } );
        }
      }
    );
    return;
  }

  // CASE #2: The user IS logged in. Redirect to pick()
  if( req.session.userId ){
    res.redirect('/pages/pick');
  }

};


var pagePick = function(req, res, next){

  var hotCorePage = hotplate.getModule('hotCorePage');
  var logger = hotplate.getModule('hotCoreServerLogger');
  var db = hotplate.get('db');

  // User is not logged in: redirect to the login page
  if(! req.session.loggedIn ){
    res.redirect('/pages/login');
    return;
  }

  // Make up a list of workspaces user has access to, and pass it to the jade template
  var list = [];
  var workspaces = db.collection('workspaces');
 
  workspaces.find( { 'access._id': ObjectId( req.session.userId ) }).toArray( function( err, docs ){
    if( err ){
      Logger({ logLevel: 4, errorName: err.name, message: err.message, req: req });
      res.status = 500;
      hotplate.get('errorPage')(req, res, next);
    } else {
      docs.forEach( function(workspace){
        list.push( { name: workspace.name, id: workspace._id } );
      });

      // hotplate.log("%j", list );

      var extraCsses = (new hotCorePage.Csses).add('hotDojoAuth', 'rrl.css');
      var extraVars = new hotCorePage.Vars();
      extraVars.add( 'hotDojoAuth', 'loggedIn', true );
      extraVars.add( 'hotDojoAuth', 'login', req.session.login );
      extraVars.add( 'hotDojoAuth', 'userId', req.session.userId );

      // There are no workspaces available
      if( list.length == 0){

        hotCorePage.processPageTemplate(
          {
            csses: extraCsses,
            vars : extraVars,
            body : '<body class="claro">' +
                   '  <div id="pickFormEmpty">' +
                   '    <p id="noWorkspaces">No workspace to pick!</p>' +
                   '    <p id="registerInstead">Go and <a href="/pages/register">register one</a>!</p>' +
                   '  </div>' +
                   '</body>'
          },
          req,
          'hotDojoAuth/pickButEmptyPage',
          function(err, result){
            res.send( result );
         }
        );

      // If there is only one workspace in the list, there is no point in having to pick: goes straight there
      } else if( list.length == 1){
        res.redirect( hotplate.get('afterLoginPage') + list[0].id);

      // There is a proper list of workspaces -- let the user pick
      } else {

        // Render the pick list 
        var pickList = '<ul class="simpleList">' + "\n";
        list.forEach(function(item){
          pickList += '<li><a href="' + hotplate.get('afterLoginPage') + item.id + '">' + item.name + '</a></li>' + "\n";
        });
        pickList += "</ul>" + "\n";

        var extraCsses = (new hotCorePage.Csses).add('hotDojoAuth', 'rrl.css');

        hotCorePage.processPageTemplate(
          {
            csses: extraCsses, 
            vars : extraVars,
            body : '<body class="claro"><div id="pickForm">' + pickList + '</div></body>' 
          },
          req,
          'hotDojoAuth/pickPage',
          function( err, result ){
            res.send( result );
            logger.log( { message: "Pick page served" } );
          } 
        );

      }
    }
  });

};





