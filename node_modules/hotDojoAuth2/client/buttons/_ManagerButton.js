

define([

   "dojo/_base/declare",
   "dojo/dom-class",
   "dojo/Deferred",

   "hotplate/hotDojoWidgets/ConfirmDialog",

   "./_Button",

   ], function(

     declare
     , domClass
     , Deferred

     , ConfirmDialog

     , _Button

 ){

  return declare( [ _Button ], {

    templateString: '<div><div class="login-button" data-dojo-type="dijit/form/Button" data-dojo-attach-point="button" data-dojo-props="iconClass: \'login-button-${strategyId}\'"></div><div class="status-off" data-dojo-attach-point="accessIcon"></div></div>',

    strategyData: null,
    resultSet: [],

    constructor: function( params ){
      var self = this;

      //  Create attributes that are local to the object
      self.strategyData = params.strategyData;
      self.resultSet = params.resultSet;

      // Observe the result set. If things change, the object
      // will update its internal values (`active` and `strategyData`) accordingly
      self.resultSet.observe( function( object, removeFrom, insertedInto ) {

        if( object.strategyId === self.strategyId ){

          // It's a deletion
          if( removeFrom != -1 && insertedInto == -1 ){
            self.set( 'active', false );
            self.set( 'strategyData', null );
          }

          // It's a addition
          if( removeFrom == -1 && insertedInto != -1 ){
            self.set( 'active', true );
            self.set( 'strategyData', object );
          }

          // It's an edit
          if( removeFrom == -1 && insertedInto == -1 ){
            self.set( 'strategyData', object );
          }
        }

      }, true );
    },


    postCreate: function(){
      var self = this;

      this.inherited(arguments); 
      if( self.strategyData ) self.set( 'active', true );
    },

    // When set as "active", it will give visual feedback 
    _setActiveAttr: function( value ){
      this._set( 'active', value );
      
      if( value ){
        domClass.add( this.accessIcon, 'status-on' );
        domClass.remove( this.accessIcon, 'status-off' );
      } else {
        domClass.add( this.accessIcon, 'status-off' );
        domClass.remove( this.accessIcon, 'status-on' );
      }
    }, 


    _deleteStrategyData: function( title, content ){

      var self = this;
      deferred = new Deferred();

      var myDialog = new ConfirmDialog({
        title: title,
        content: content,
      });
      myDialog.startup();
      myDialog.on( 'dialogconfirmed', function( e ){
        self.store.remove( self.strategyData._id ).then(
          function( r ){
            self.strategyData = null;
            deferred.resolve( true );
          },
          function( err ){
            (new ConfirmDialog( { cancelButton: false, title: "Failed", content: "Operation failed" })).startup();
            deferred.reject( err );
          }
        );
      });

      return deferred.promise
    },

  });

});





