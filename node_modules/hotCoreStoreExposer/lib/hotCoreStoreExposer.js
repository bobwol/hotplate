"use strict";

/*!
 * Module dependencies.
 */

var
  hotplate = require('hotplate')
, path = require('path')
, hotCoreStoreRegistry = require( 'hotCoreStoreRegistry' )
;


hotplate.config.set( 'hotCoreStoreExposer.storeUrlPrefix', "/stores" );

// Run onlineAll for each store with a publicUrl attribute

hotplate.hotEvents.on( 'setRoutes', hotplate.cachable( function( app, done ){

  hotCoreStoreRegistry.getAllStores( function( err, allStores ){  
    
    Object.keys( allStores.stores ).forEach( function( storeName ){
      
      var storeEntry = allStores.stores[ storeName ];

      // The store has a public URL: add it to the list of stores to expose
      if( storeEntry.storeObject.publicURL ){
        var url = path.join( hotplate.config.get( 'hotCoreStoreExposer.storeUrlPrefix' ), storeEntry.storeObject.publicURL );
        storeEntry.Store.onlineAll( app, url, ':' + storeEntry.storeObject.idProperty );
      }
    });

    done( null );
  });
}))





