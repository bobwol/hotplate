
define([
  "dojo/_base/declare",
  "dojo/topic",
  "dojo/when",
  "dojo/aspect",
  "hotplate/hotDojoStores/stores",
  "hotplate/hotDojoStores/AppStoreNotify",
  "hotplate/hotDojoCometMessages/messages",
  "hotplate/hotDojoGlobals/globals",

  "dojo/domReady!",
   ], function(
   declare
 , topic
 , when
 , aspect
 , stores
 , dummy
 , messages
 , globals
 ){


  var r = {};
  Object.keys( vars.hotCoreStoreConfig.configStores ).forEach( function( storeName ){

    // Get the store's object
    // TODO: Here, add req.params.workspaceId (if present) and req.session.userId as options
    // (BEFORE that, decide on "global" variables for userId and workspaceId to harmonise them)
    // (NOTE that userId is missing from the page's vars)
    var store = stores( storeName );

    // Put the in-page record in the store's cache
    store.memCache.put( vars.hotCoreStoreConfig.configStoreRecords[ storeName ] );

    // Put the in-page record in 'r', which will be returned to the caller
    r[ storeName ] = vars.hotCoreStoreConfig.configStoreRecords[ storeName ];

    // Subscribe to changes to those records, so that the 'r' variable (representing the current
    // configuration) always stays current
    topic.subscribe('storeUpdate', function( from, message){

      var idProperty = vars.hotCoreStoreVars.stores[ message.storeName ].idProperty;
      var target = vars.hotCoreStoreVars.stores[ message.storeName ].target;

      // TODO: Check which variant actually works... the current one hasn't been tested
      // if( message.storeName === 'workspaceConfig' && message.storeTarget == workspaceConfigStore.target && message.objectId === globals.workspaceId ){

      // if( typeof( r[ message.storeName ] ) !== 'undefined' && message.objectId ===  r[ message.storeName ][ idProperty ] ){
      // if( typeof( r[ message.storeName ] ) !== 'undefined' && store.target ==  ){
      if( message.storeName == storeName && message.storeTarget == target ){
        r[ storeName ] = message.object;
        topic.publish('configChange/' + storeName, r[ storeName ], message );
      }
    });



  });

  return r;

});


