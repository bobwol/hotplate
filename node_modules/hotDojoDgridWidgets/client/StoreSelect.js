define([
   "dojo/_base/declare",
   "dojo/when",
   "dojo/topic",
   "dojo/on",
   "dojo/_base/lang",
   "dojo/dom-construct",
   "dojo/dom-style",
   "dojo/dom-attr",
   "dojo/aspect",

   "dijit/_WidgetBase",
   "dijit/Dialog",
   "dijit/_OnDijitClickMixin",
   "dijit/focus",
   "dijit/form/Button",
   "dijit/layout/BorderContainer",
   "dijit/_Container",
   "dijit/layout/_ContentPaneResizeMixin",
   "dijit/_TemplatedMixin",
   "dijit/_WidgetsInTemplateMixin",

   'dgrid/List',
   'dgrid/OnDemandList',
   "dgrid/Selection",
   "dgrid/Keyboard",
   "dgrid/util/mouse",
   "dgrid/extensions/DijitRegistry",
   'put-selector/put',

   "hotplate/hotDojoSubmit/defaultSubmit",
   "hotplate/hotDojoWidgets/BusyButton",
   "hotplate/hotDojoWidgets/ConfirmDialog",

   ], function(
     declare
     , when
     , topic
     , on
     , lang
     , domConstruct
     , domStyle
     , domAttr
     , aspect

     , _WidgetBase
     , Dialog
     , _OnDijitClickMixin
     , focusUtil
     , Button
     , BorderContainer
     , _Container
     , _ContentPaneResizeMixin
     , _TemplatedMixin
     , _WidgetsInTemplateMixin

     , List
     , OnDemandList
     , Selection
     , Keyboard
     , mouse
     , DijitRegistry
     , put

     , ds
     , BusyButton
     , ConfirmDialog

 ){


    return declare( [ _WidgetBase, _TemplatedMixin, _WidgetsInTemplateMixin, _Container, _ContentPaneResizeMixin ] , {

      templateString: '<div class="store-select">\n' +
                      '<table style="height:100%;width:100%" >\n'+
                      '<tr><td>\n'+
                      '\n'+
                      '\n'+
                      '\n'+
                      '  <div class="label button"><div data-dojo-attach-point="label">Pick</div></div>\n' +
                      '  <div class="arrow button"></div>\n' +
                      '</td></tr>\n'+
                      '<tr><td style="height:100%;border-style:solid;">\n'+
                      '  <div class="list-widget" data-dojo-attach-point="listWidgetNode"></div>\n'+
                      '</td></tr>\n'+
                      '</table>\n'+
                      '</div>\n'+
                      '\n'+
                      '',


      widgetsInTemplate: true,
      // Store
      storeName: '',
      store: null,
      renderRow: function( o ){ return "renderRow not defined"; } ,

      selectedId: null,
      listWidget: null,

      constructor: function( params ){
        // this.store = stores( params.storeName, params.storeFields );
      },

      // Proxy method for listwidget.row()
      row: function( p ){
        return this.listWidget.row( p );
      },

      postCreate: function(){

        var self = S = this;
        this.inherited(arguments); 

        put( self.domNode, '.dgrid-select' );

        var ListConstructor = declare( [ OnDemandList, Selection, Keyboard, DijitRegistry ], {
          renderRow: self.renderRow,
        } );

        // Make a listWidget
        self.listWidget = new ListConstructor( { store: this.store }, self.listWidgetNode );

        // A record was selected beforehand: load it up
        if( this.selectedId !== null ){
          self.label.innerHTML = "Loading...";

          when( self.store.get( self.selectedId ) ).then(
            function( res ) {
              self.label.innerHTML = '';
              put( self.label, self.renderRow( res ) );
            },
            function( err ){
              self.label.innerHTML = 'Error loading item!';
              connectUp();
            }
          );
        } else {
          connectUp();
        }

        function connectUp(){

        }



      },

      resize: function(){
        this.listWidget.resize();

        this.inherited(arguments); 
      },

      destroy: function(){
        this.listWidget.destroy();

        this.inherited(arguments); 
      },

      startup: function(){
        this.inherited(arguments); 
      },

    });
 

});

